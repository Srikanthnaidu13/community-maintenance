<!DOCTYPE html>
<html lang="en">
<head>
  <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CivicFix - Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:'Inter', sans-serif; }
body { min-height:100vh; background:#1f2937; color:white; position:relative; overflow-x:hidden; }
body::before {
  content:''; position: fixed; top:0; left:0; width:100vw; height:100vh;
  background: radial-gradient(circle at 20% 20%, rgba(59,130,246,0.1), transparent 40%),
              radial-gradient(circle at 80% 70%, rgba(16,185,129,0.1), transparent 40%);
  animation: float 25s linear infinite; z-index:0;
}
@keyframes float {0%{transform:translate(0,0);}50%{transform:translate(-50px,50px);}100%{transform:translate(0,0);}}

/* Navbar */
.navbar { position: fixed; top:0; left:0; right:0; display:flex; justify-content:space-between; align-items:center; padding:15px 40px; background: rgba(31,41,55,0.9); backdrop-filter: blur(10px); z-index:2; }
.navbar .brand { font-size:36px; font-weight:800; color:#10B981; background:linear-gradient(135deg,#10B981,#3B82F6); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.navbar .nav-links a { margin-left:20px; padding:8px 18px; border-radius:12px; text-decoration:none; color:white; font-weight:600; transition:0.3s; }
.navbar .nav-links a:hover { background: rgba(255,255,255,0.15); backdrop-filter: blur(5px); }

/* Table Section */
.container { position:relative; z-index:2; max-width:1200px; margin:100px auto 50px auto; padding:20px; }
.table-section { background: rgba(255,255,255,0.05); backdrop-filter: blur(25px); padding:20px; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.2); margin-bottom:30px; }
.table-section h2 { margin-bottom:15px; color:white; font-size:28px; text-align:center; }
table { width:100%; border-collapse:collapse; }
th, td { padding:12px 15px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.2); }
th { color:#10B981; font-size:16px; }
td { color:#D1D5DB; font-size:14px; }
tr:hover { background: rgba(16,185,129,0.1); }
button.view-btn { padding:6px 12px; border:none; border-radius:8px; cursor:pointer; background:#3B82F6; color:white; font-weight:600; transition:0.3s; }
button.view-btn:hover { background:#2563EB; }

/* Modal */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10; }
.modal-content { background: #111827; padding:30px; border-radius:20px; width:90%; max-width:600px; position:relative; color:white; box-shadow:0 10px 40px rgba(0,0,0,0.5); max-height:80vh; overflow-y:auto; }
.modal-content img { max-width:100%; margin-top:15px; border-radius:12px; }
.modal-content h2 { margin-bottom:15px; color:#10B981; font-size:28px; }
.modal-content p { margin-bottom:10px; color:#D1D5DB; line-height:1.5; }
.close-modal { position:absolute; top:15px; right:20px; font-size:22px; font-weight:bold; cursor:pointer; color:#F87171; transition:0.3s; }
.close-modal:hover { color:#F43F5E; }

/* Status Buttons */
.status-btn { flex:1; padding:10px 15px; border:none; border-radius:12px; cursor:pointer; margin:5px 0; font-weight:600; font-size:14px; transition:0.3s; }
.status-Pending { background:#F59E0B; color:white; }
.status-Viewed { background:#3B82F6; color:white; }
.status-InProgress { background:#6366F1; color:white; }
.status-Resolved { background:#10B981; color:white; }
.status-btn:hover { opacity:0.85; }

/* Button container */
.modal-buttons { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-top:15px; }

/* Responsive */
@media(max-width:768px){ table, th, td { font-size:13px; } .modal-content { padding:20px; } }
.filters {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:20px;
}
.filters select,
.filters input {
  padding:10px;
  border-radius:10px;
  background:#1f2937;
  color:white;
  border:1px solid rgba(255,255,255,0.2);
  font-weight:600;
}

.assign-select {
  width:100%;
  padding:10px;
  margin-top:5px;
  border-radius:10px;
  background:#1f2937;
  color:white;
  border:1px solid rgba(255,255,255,0.2);
  font-weight:600;
}
.assign-select option {
  background:#111827;
}
.modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  justify-content:center;
  align-items:center;
  z-index:99999;  /* âœ… above map */
}
.modal-content {
  position:relative;
  z-index:100000; /* âœ… above everything */
}

/* ===== MAP SECTION ===== */
.map-section {
  margin: 40px auto 0 auto;
  max-width: 1200px;
  text-align: center;
  position: relative;
  z-index: 2;
}

.map-wrapper {
  width: 420px;           /* ðŸ‘ˆ square size */
  height: 420px;
  margin: 10 auto;         /* ðŸ‘ˆ centers it */
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 12px 30px rgba(0,0,0,0.35);
  border: 1px solid rgba(255,255,255,0.15);
}

#map {
  width: 100%;
  height: 100%;
}
/* MAP + INFO SIDE BY SIDE */
.admin-map-layout{
  display:flex;
  gap:16px;
  align-items:flex-start;
  margin-top:30px;
}

/* LEFT MAP */
.map-card{
  width:420px;
  background: rgba(255,255,255,0.05);
  padding:16px;
  border-radius:20px;
}

/* SQUARE MAP */
.map-wrapper{
  width:100%;
  aspect-ratio:1/1;
  border-radius:18px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,0.15);
}
#map{ width:100%; height:100%; }

/* RIGHT INFO PANEL */
.info-card{
  flex:1;
  background: rgba(255,255,255,0.05);
  padding:20px;
  border-radius:20px;
  min-height:420px;
}

/* placeholder */
.info-placeholder{
  color:#9CA3AF;
  font-style:italic;
  margin-top:20px;
}

/* PRIORITY BADGES */
.badge{
  padding:6px 12px;
  border-radius:999px;
  font-weight:800;
  font-size:13px;
}
.badge-high{
  background: rgba(239,68,68,0.2);
  color:#F87171;
}
.badge-medium{
  background: rgba(245,158,11,0.2);
  color:#FBBF24;
}
.badge-low{
  background: rgba(16,185,129,0.2);
  color:#34D399;
}

/* MOBILE */
@media(max-width:900px){
  .admin-map-layout{ flex-direction:column; }
  .map-card{ width:100%; }
}

.admin-map-layout{
  display:flex;
  gap:18px;
  align-items:flex-start;
  margin-top:25px;
  position:relative;
  z-index:2;
}

/* LEFT MAP CARD */
.map-card{
  width:420px;
  background: rgba(255,255,255,0.05);
  padding:16px;
  border-radius:20px;
  border:1px solid rgba(255,255,255,0.12);
}

/* square map */
.map-wrapper{
  width:100%;
  height:420px;
  border-radius:18px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,0.15);
}
#map{ width:100%; height:100%; }

/* RIGHT TABLE CARD */
.side-table-card{
  flex:1;
  min-height:420px;
  background: rgba(255,255,255,0.05);
  padding:16px;
  border-radius:20px;
  border:1px solid rgba(255,255,255,0.12);
}

/* table style */
.mini-table-wrap{
  margin-top:10px;
  max-height:360px;
  overflow:auto;
  border-radius:14px;
}

.mini-table{
  width:100%;
  border-collapse:collapse;
}
.mini-table th, .mini-table td{
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,0.12);
  font-size:13px;
}
.mini-table th{
  position:sticky;
  top:0;
  background:#111827;
  color:#10B981;
  font-weight:800;
}
.mini-table td{
  color:#D1D5DB;
}

.priority-badge{
  padding:6px 10px;
  border-radius:999px;
  font-weight:800;
  font-size:12px;
  display:inline-block;
}
.p-high{ background: rgba(239,68,68,0.20); color:#F87171; }
.p-medium{ background: rgba(245,158,11,0.20); color:#FBBF24; }
.p-low{ background: rgba(16,185,129,0.20); color:#34D399; }

/* mobile */
@media(max-width:900px){
  .admin-map-layout{ flex-direction:column; }
  .map-card{ width:100%; }
}
.map-area{
  position: relative;
  width: 420px;
  height: 420px;
  margin: 0 auto;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 12px 30px rgba(0,0,0,0.35);
  border: 1px solid rgba(255,255,255,0.15);
}
#map{
  width: 100%;
  height: 100%;
}

/* Map container */
.map-area{
  position: relative;        /* ðŸ”‘ required for floating button */
  width: 420px;
  height: 420px;
  margin: 0 auto;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 12px 30px rgba(0,0,0,0.35);
  border: 1px solid rgba(255,255,255,0.15);
}

/* Leaflet map */
#map{
  width: 100%;
  height: 100%;
}

/* Floating recenter button (Google Maps style) */
.recenter-btn{
  position: absolute;
  right: 14px;
  bottom: 14px;
  width: 44px;
  height: 44px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(17,24,39,0.9);
  color: #E5E7EB;
  font-size: 18px;
  cursor: pointer;
  box-shadow: 0 10px 25px rgba(0,0,0,0.35);
  backdrop-filter: blur(10px);
  z-index: 500;              /* stays above map tiles */
}

.recenter-btn:hover{
  transform: translateY(-1px);
}
#viewModal { z-index: 9999 !important; }
#map { z-index: 1; }
</style>
</head>
<body>

<div class="navbar">
  <div class="brand">CivicFix Admin</div>
  <div class="nav-links">
    <a href="/logout" id="logoutBtn">Logout</a>
  </div>
</div>



<div class="container table-section">
  <div class="filters">
  <select id="filterCategory">
    <option value="">All Categories</option>
    <option>Road</option>
    <option>Water</option>
    <option>Electricity</option>
    <option>Garbage</option>
  </select>

  <select id="filterPriority">
    <option value="">All Priorities</option>
    <option>High</option>
    <option>Medium</option>
    <option>Low</option>
  </select>

  <input type="date" id="filterDate">

  <select id="filterImage">
    <option value="">Has Image?</option>
    <option value="yes">Yes</option>
    <option value="no">No</option>
  </select>
</div>

  <h2>All Complaints</h2>
  <table>
    <thead>
      <tr><th>User</th><th>Complaint</th><th>Status</th><th>Date</th><th>Action</th></tr>
    </thead>
    <tbody id="adminComplaintsBody"></tbody>
  </table>
</div>


<div class="admin-map-layout">

  <!-- LEFT: MAP -->
  <div class="map-card">
    <h2 class="section-title">Complaint Locations</h2>

    <!-- MAP AREA (relative container) -->
    <div class="map-area">
      <div id="map"></div>

      <!-- ðŸ”µ Floating Recenter Button -->
      <button
        id="recenterBtn"
        class="recenter-btn"
        title="Recenter to my location">
        â¦¿
      </button>
    </div>
  </div>


  <!-- RIGHT: TABLE (Title | Category | Priority) -->
  <div class="side-table-card">
    <h2 class="section-title">Live Complaint List</h2>

    <div class="mini-table-wrap">
      <table class="mini-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Category</th>
            <th>Priority</th>
          </tr>
        </thead>
        <tbody id="miniTableBody"></tbody>
      </table>
    </div>
  </div>

</div>


<!-- Modal -->
<div id="viewModal" class="modal">
  <div class="modal-content">
    <span id="closeModal" class="close-modal">&times;</span>
    <h2 id="modalTitle"></h2>
    <p><strong>Description:</strong> <span id="modalDescription"></span></p>
    <p><strong>Category:</strong> <span id="modalCategory"></span></p>
    <p><strong>Priority:</strong> <span id="modalPriority"></span></p>
    <p><strong>Location:</strong> <span id="modalLocation"></span></p>
      <p><strong>Assigned Department:</strong>
    <select id="assignDept" class="assign-select">
      <option value="">-- Assign Department --</option>
      <option value="Road Dept | Ramesh Kumar | 9876543210">
        Road Dept â€“ Ramesh Kumar (ðŸ“ž 9876543210)
      </option>
      <option value="Water Dept | Suresh Naidu | 9123456789">
        Water Dept â€“ Suresh Naidu (ðŸ“ž 9123456789)
      </option>
      <option value="Electricity Dept | Anjali Sharma | 9988776655">
        Electricity Dept â€“ Anjali Sharma (ðŸ“ž 9988776655)
      </option>
    </select>
  </p>
    <img id="modalImage" src="" style="display:none;">
    <div id="voiceSection" style="margin-top:15px; display:none;">
  <p><strong>Voice Complaint:</strong></p>
  <audio id="modalVoice" controls style="width:100%;"></audio>
</div>
    <div class="modal-buttons">
      <button id="btnPending" class="status-btn status-Pending" onclick="updateStatus('Pending')">Pending</button>
      <button id="btnInProgress" class="status-btn status-InProgress" onclick="updateStatus('In Progress')">In Progress</button>
      <button id="btnResolved" class="status-btn status-Resolved" onclick="updateStatus('Resolved')">Resolved</button>
    </div>
  </div>
</div>
<script>
/* ================= MAP INIT (ONLY ONCE) ================= */
/* =========================
   GLOBALS
========================= */
let currentComplaintId = null;

// map + markers
let mapInstance = null;
let mapMarkersById = {}; // { complaintId: leafletMarker }
let adminLatLng = null;
let adminMarker = null;

/* =========================
   HELPERS
========================= */
function getPriorityColor(priority) {
  if (priority === "High") return "red";
  if (priority === "Medium") return "yellow";
  return "green";
}
function getPriorityClass(priority) {
  if (priority === "High") return "p-high";
  if (priority === "Medium") return "p-medium";
  return "p-low";
}

/* =========================
   INIT MAP (ONLY ONCE)
========================= */
function initMap() {
  if (mapInstance) return; // prevent redeclare

  mapInstance = L.map("map").setView([20.5937, 78.9629], 5);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â© OpenStreetMap"
  }).addTo(mapInstance);

  // auto detect admin location on load
  detectAdminLocation(true);

  // recenter button
  const recenterBtn = document.getElementById("recenterBtn");
  if (recenterBtn) {
    recenterBtn.addEventListener("click", () => {
      if (adminLatLng) {
        mapInstance.flyTo(adminLatLng, 14, { duration: 0.8 });
        if (adminMarker) adminMarker.openPopup();
      } else {
        detectAdminLocation(true);
      }
    });
  }
}

/* =========================
   ADMIN LOCATION
========================= */
function detectAdminLocation(autoZoom) {
  if (!navigator.geolocation) return;

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      adminLatLng = [lat, lng];

      if (!adminMarker) {
        adminMarker = L.circleMarker(adminLatLng, {
          radius: 9,
          color: "#3B82F6",
          fillColor: "#3B82F6",
          fillOpacity: 0.95
        }).addTo(mapInstance).bindPopup("ðŸ‘® Admin (You)");
      } else {
        adminMarker.setLatLng(adminLatLng);
      }

      if (autoZoom) {
        mapInstance.setView(adminLatLng, 14);
      }
    },
    () => {
      // if denied, keep India view
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

/* =========================
   MINI TABLE (RIGHT SIDE)
   Only Title, Category, Priority
========================= */
function renderMiniTable(data) {
  const tbody = document.getElementById("miniTableBody");
  if (!tbody) return;

  tbody.innerHTML = "";

  data.forEach((c) => {
    const pr = c.priority || "Low";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.title || "-"}</td>
      <td>${c.category || "-"}</td>
      <td><span class="priority-badge ${getPriorityClass(pr)}">${pr}</span></td>
    `;
    tbody.appendChild(tr);
  });
}

/* =========================
   MAP MARKERS
========================= */
function renderMapMarkers(data) {
  // clear old markers
  Object.values(mapMarkersById).forEach((m) => mapInstance.removeLayer(m));
  mapMarkersById = {};

  data.forEach((c) => {
    if (c.lat == null || c.lng == null || c.lat === "" || c.lng === "") return;

    const lat = parseFloat(c.lat);
    const lng = parseFloat(c.lng);
    if (isNaN(lat) || isNaN(lng)) return;

    const color = getPriorityColor(c.priority);

    const marker = L.circleMarker([lat, lng], {
      radius: 9,
      color,
      fillColor: color,
      fillOpacity: 0.9
    }).addTo(mapInstance);

    // hover tooltip
    marker.bindTooltip(
      `<strong>${c.title || ""}</strong><br>${c.category || ""}`,
      { direction: "top", offset: [0, -10] }
    );

    mapMarkersById[c.id] = marker;
  });
}

/* =========================
   MAIN TABLE (NO CHANGE)
========================= */
function renderMainTable(data) {
  const tbody = document.getElementById("adminComplaintsBody");
  if (!tbody) return;

  tbody.innerHTML = "";
  data.forEach((c) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.username || "-"}</td>
      <td>${c.title || "-"}</td>
      <td>${c.status || "-"}</td>
      <td>${c.created_at || "-"}</td>
      <td><button class="view-btn" onclick="openModal(${c.id})">View</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/* =========================
   LOAD COMPLAINTS
========================= */
function loadComplaints() {
  fetch("/get-complaints")
    .then((res) => res.json())
    .then((data) => {
      renderMainTable(data);
      renderMiniTable(data);
      renderMapMarkers(data);
    })
    .catch((err) => console.error("Load error:", err));
}

/* =========================
   MODAL (UPDATED CLEAN)
========================= */
function openModal(id) {
  currentComplaintId = id;

  fetch("/get-complaints")
    .then((res) => res.json())
    .then((data) => {
      const c = data.find((x) => x.id === id);
      if (!c) return;

      // modal elements (must exist)
      modalTitle.innerText = c.title || "";
      modalDescription.innerText = c.description || "";
      modalCategory.innerText = c.category || "";
      modalPriority.innerText = c.priority || "";

      const hasCoords = c.lat != null && c.lng != null && c.lat !== "" && c.lng !== "";
      modalLocation.innerText = hasCoords ? `${c.lat}, ${c.lng}` : "N/A";

      // image
      if (c.image) {
        modalImage.src = `/uploads/${c.image}`;
        modalImage.style.display = "block";
      } else {
        modalImage.style.display = "none";
      }

      // voice
      if (c.voice) {
        modalVoice.src = `/uploads/${c.voice}`;
        voiceSection.style.display = "block";
      } else {
        modalVoice.src = "";
        voiceSection.style.display = "none";
      }

      // show modal ABOVE map
      viewModal.style.display = "flex";

      // fly to marker + highlight
      if (hasCoords) {
        const lat = parseFloat(c.lat);
        const lng = parseFloat(c.lng);
        if (!isNaN(lat) && !isNaN(lng)) {
          mapInstance.flyTo([lat, lng], 16, { duration: 1.0 });

          const marker = mapMarkersById[c.id];
          if (marker) {
            marker.setStyle({ radius: 14, fillOpacity: 1 });
            if (marker.openTooltip) marker.openTooltip();

            setTimeout(() => {
              marker.setStyle({ radius: 9, fillOpacity: 0.9 });
            }, 1200);
          }
        }
      }
    })
    .catch((err) => console.error("openModal error:", err));
}

closeModal.onclick = () => {
  viewModal.style.display = "none";
  // stop voice when closing
  if (modalVoice) {
    modalVoice.pause();
    modalVoice.currentTime = 0;
  }
};

/* =========================
   STATUS UPDATE (NO CHANGE)
========================= */
function updateStatus(status) {
  fetch(`/update-status/${currentComplaintId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status })
  }).then(() => {
    viewModal.style.display = "none";
    loadComplaints();
  });
}

/* =========================
   START
========================= */
initMap();
loadComplaints();
setInterval(loadComplaints, 10000);
</script>


</body>
</html>
